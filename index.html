<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Personal - Cálculo Dinámico</title>
    <!-- Incluye Tailwind CSS CDN para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la librería de Chart.js para dibujar gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ESTABILIZACIÓN: Fuerza la relación de aspecto 1:1 para el gráfico */
        #chart-container {
            width: 100%;
            max-width: 550px;
            aspect-ratio: 1 / 1; 
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl shadow-purple-200 rounded-2xl p-6 md:p-10 border-t-8 border-purple-600">
        <h1 class="text-3xl md:text-4xl font-extrabold text-purple-800 text-center mb-8">Sistema de Optimización de Personal para Control Total S.A.S</h1>
        
        <!-- Resumen del Modelo Implementado -->
        <div class="bg-purple-50 p-6 rounded-xl shadow-inner mb-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div>
                    <h3 class="font-semibold text-lg text-purple-700">Variables de Decisión:</h3>
                    <ul class="list-disc list-inside mt-1 text-gray-600">
                        <li>**X:** Técnicos de Hora Pico</li>
                        <li>**Y:** Técnicos de Horario Regular</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-purple-700">Función Objetivo (Z):</h3>
                    <p class="bg-purple-200 text-purple-900 p-2 rounded font-mono text-center">MAX Z = 469.566(4X) + 469.566(3Y)</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-purple-700">Restricciones (Vinculantes):</h3>
                    <ul class="list-disc list-inside mt-1 text-gray-600">
                        <li id="restriction1Text">R1: X + Y ≤ 6</li>
                        <li id="restriction2Text">R2: 2X + Y ≤ 9</li>
                        <li>X, Y ≥ 0</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Controles Interactivos -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-10">
            <h3 class="font-semibold text-lg text-purple-700 mb-4">Controles Interactivos</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="r1Slider" class="block text-gray-700 font-medium">Límite R1 (X + Y ≤ <span id="r1Value" class="font-bold text-purple-700">6</span>)</label>
                    <input id="r1Slider" type="range" min="1" max="20" value="6" class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                    <p id="r1Context" class="text-xs text-gray-500 mt-1">Representa el límite total de técnicos que se pueden contratar.</p>
                </div>
                <div>
                    <label for="r2Slider" class="block text-gray-700 font-medium">Límite R2 (2X + Y ≤ <span id="r2Value" class="font-bold text-purple-700">9</span>)</label>
                    <input id="r2Slider" type="range" min="1" max="20" value="9" class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                    <p id="r2Context" class="text-xs text-gray-500 mt-1">Representa la carga de trabajo máxima soportada en horas pico.</p>
                </div>
            </div>
        </div>

        <!-- Panel de Resultados -->
        <div class="bg-green-100 border-l-4 border-green-600 text-green-800 p-4 rounded-lg mb-4" role="alert">
            <p class="font-bold text-xl">Solución Óptima (Método Simplex)</p>
            <div id="resultadoTexto" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                <!-- El contenido se inyectará aquí desde JavaScript -->
            </div>
        </div>

        <!-- Contenedor del Gráfico -->
        <div id="chart-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-6">
            <canvas id="simplexChart"></canvas>
        </div>
    </div>

    <script>
        let simplexChartInstance = null; // Variable global para la instancia del gráfico

        // CONSTANTES DEL MODELO
        const C_BASE = 469566;
        const C_X_REL = 4; 
        const C_Y_REL = 3; 

        // Función para calcular intersección (ahora recibe los límites)
        function calcularInterseccion(r1Limit, r2Limit) {
            const x = r2Limit - r1Limit;
            const y = 2 * r1Limit - r2Limit;
            return { x, y };
        }

        function esPuntoFactible(x, y, r1Limit, r2Limit) {
            return (
                x >= 0 && y >= 0 &&           // No negatividad
                x + y <= r1Limit &&          // R1
                2*x + y <= r2Limit           // R2
            );
        }

        // Función para evaluar Z en un punto
        function evaluarZ(x, y) {
            return C_BASE * (C_X_REL * x + C_Y_REL * y);
        }

        /**
         * Resuelve un problema de programación lineal usando el Método Simplex.
         * Asume un problema de maximización con restricciones <=.
         * @returns {{x: number, y: number, z: number}} El punto óptimo y el valor máximo de Z.
         */
        function solveWithSimplex(r1Limit, r2Limit) {
            // 1. Configurar el Tableau Simplex Inicial
            // Z - (C_X_REL*C_BASE)X - (C_Y_REL*C_BASE)Y = 0
            // X + Y + s1 = r1Limit
            // 2X + Y + s2 = r2Limit
            let tableau = [
                // Z,  X,                Y,                s1, s2, Solución
                [1, -(C_X_REL * C_BASE), -(C_Y_REL * C_BASE), 0,  0,  0],        // Fila Z (Función Objetivo)
                [0, 1,                1,                1,  0,  r1Limit], // Fila s1 (Restricción 1)
                [0, 2,                1,                0,  1,  r2Limit]  // Fila s2 (Restricción 2)
            ];

            const MAX_ITERATIONS = 10; // Para evitar bucles infinitos
            for (let iter = 0; iter < MAX_ITERATIONS; iter++) {
                // 2. Encontrar la columna pivote (el más negativo en la fila Z)
                const zRow = tableau[0];
                let pivotColIndex = -1;
                let minZValue = 0;
                for (let j = 1; j < zRow.length - 1; j++) { // Ignorar Z y Solución
                    if (zRow[j] < minZValue) {
                        minZValue = zRow[j];
                        pivotColIndex = j;
                    }
                }

                // 3. Si no hay negativos, hemos llegado a la solución óptima
                if (pivotColIndex === -1) break;

                // 4. Encontrar la fila pivote (menor ratio positivo)
                let pivotRowIndex = -1;
                let minRatio = Infinity;
                for (let i = 1; i < tableau.length; i++) {
                    const pivotColValue = tableau[i][pivotColIndex];
                    if (pivotColValue > 0) {
                        const ratio = tableau[i][tableau[i].length - 1] / pivotColValue;
                        if (ratio < minRatio) {
                            minRatio = ratio;
                            pivotRowIndex = i;
                        }
                    }
                }

                // 5. Realizar el pivoteo
                const pivotElement = tableau[pivotRowIndex][pivotColIndex];
                // Normalizar la fila pivote
                for (let j = 0; j < tableau[pivotRowIndex].length; j++) {
                    tableau[pivotRowIndex][j] /= pivotElement;
                }
                // Hacer ceros en las otras filas de la columna pivote
                for (let i = 0; i < tableau.length; i++) {
                    if (i !== pivotRowIndex) {
                        const factor = tableau[i][pivotColIndex];
                        for (let j = 0; j < tableau[i].length; j++) {
                            tableau[i][j] -= factor * tableau[pivotRowIndex][j];
                        }
                    }
                }
            }

            return extractSolutionFromTableau(tableau);
        }

        /**
         * Extrae los valores de las variables de decisión del tableau final.
         * @param {number[][]} tableau - El tableau Simplex final.
         * @returns {{x: number, y: number, z: number}} La solución.
         */
        function extractSolutionFromTableau(tableau) {
            const numRows = tableau.length;
            const numCols = tableau[0].length;
            const solutionColIndex = numCols - 1;
            let solution = { x: 0, y: 0, z: tableau[0][solutionColIndex] };

            // Las variables de decisión son X (col 1) y Y (col 2)
            for (let j = 1; j <= 2; j++) { // j=1 para X, j=2 para Y
                let isBasic = false;
                let pivotRow = -1;
                let oneCount = 0;
                let zeroCount = 0;

                for (let i = 1; i < numRows; i++) {
                    if (tableau[i][j] === 1) {
                        oneCount++;
                        pivotRow = i;
                    } else if (tableau[i][j] === 0) {
                        zeroCount++;
                    }
                }

                if (oneCount === 1 && zeroCount === numRows - 2) { // Es una variable básica
                    if (j === 1) solution.x = tableau[pivotRow][solutionColIndex];
                    if (j === 2) solution.y = tableau[pivotRow][solutionColIndex];
                }
            }
            return solution;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        }

        function updateAnalysis() {
            const r1Limit = parseFloat(document.getElementById('r1Slider').value);
            const r2Limit = parseFloat(document.getElementById('r2Slider').value);

            // Actualizar etiquetas de los sliders
            document.getElementById('r1Value').textContent = r1Limit;
            document.getElementById('r2Value').textContent = r2Limit;

            // Actualizar texto de las restricciones en el resumen
            document.getElementById('restriction1Text').textContent = `R1: X + Y ≤ ${r1Limit}`;
            document.getElementById('restriction2Text').textContent = `R2: 2X + Y ≤ ${r2Limit}`;

            // --- CÁLCULO DE VÉRTICES Y ÓPTIMO ---
            const puntoCruce = calcularInterseccion(r1Limit, r2Limit);

            const vertices = [
                {x: 0, y: 0},
                {x: r2Limit / 2, y: 0},
                puntoCruce,
                {x: 0, y: r1Limit}
            ].filter(p => esPuntoFactible(p.x, p.y, r1Limit, r2Limit)); // Filtrar solo los vértices válidos

            const solucionSimplex = solveWithSimplex(r1Limit, r2Limit);
            const xOptimo = solucionSimplex.x;
            const yOptimo = solucionSimplex.y;
            const valorOptimo = solucionSimplex.z;

            document.getElementById('resultadoTexto').innerHTML = `
                <div class="col-span-2">
                    <span class="text-lg">Ganancia Máxima (Z):</span>
                    <span class="font-bold text-2xl text-green-900 ml-2">${formatCurrency(valorOptimo)}</span>
                    <span class="font-mono text-sm ml-2">en (${xOptimo.toFixed(2)}, ${yOptimo.toFixed(2)})</span>
                </div>
                <div><span class="font-semibold">${xOptimo.toFixed(0)}</span> Técnicos de Hora Pico (X)</div>
                <div><span class="font-semibold">${yOptimo.toFixed(0)}</span> Técnicos de Horario Regular (Y)</div>
            `;

            const valorRelativoOptimo = C_X_REL * xOptimo + C_Y_REL * yOptimo;

            // --- PREPARACIÓN DE DATOS PARA EL GRÁFICO ---
            const MAX_AXIS = 20;
            const r1Points = [], r2Points = [], foLinePoints = [];

            for(let x = 0; x <= MAX_AXIS; x += 0.1) {
                let y1 = r1Limit - x;
                if (y1 >= 0) r1Points.push({x: x, y: y1});

                let y2 = r2Limit - 2 * x;
                if (y2 >= 0) r2Points.push({x: x, y: y2});
                
                let y_fo = (valorRelativoOptimo - C_X_REL * x) / C_Y_REL;
                if (y_fo >= 0) foLinePoints.push({x: x, y: y_fo});
            }
            
            // --- CREACIÓN DEL GRÁFICO ---
            if (simplexChartInstance) {
                simplexChartInstance.destroy(); // Destruir el gráfico anterior
            }
            const ctx = document.getElementById('simplexChart').getContext('2d');
            
            simplexChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'R1: Límite Total',
                            data: r1Points,
                            borderColor: 'rgb(59, 130, 246)', 
                            borderWidth: 3,
                            showLine: true,
                            pointRadius: 0
                        },
                        {
                            label: 'R2: Carga Pico',
                            data: r2Points,
                            borderColor: 'rgb(239, 68, 68)', 
                            borderWidth: 3,
                            showLine: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Región Factible',
                            data: vertices.concat(vertices[0]), // Cerrar el polígono
                            backgroundColor: 'rgba(168, 85, 247, 0.3)', 
                            borderColor: 'rgba(168, 85, 247, 0.7)',
                            borderWidth: 1,
                            fill: true,
                            showLine: true,
                            tension: 0,
                            pointRadius: 0
                        },
                        {
                            label: 'Función Objetivo (Z máx)',
                            data: foLinePoints,
                            borderColor: 'rgb(22, 163, 74)', 
                            borderWidth: 3,
                            borderDash: [10, 5],
                            showLine: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Punto Óptimo',
                            data: [{x: xOptimo, y: yOptimo, label: `Óptimo (${xOptimo}, ${yOptimo})`}],
                            backgroundColor: 'rgb(255, 193, 7)', 
                            borderColor: 'rgb(0, 0, 0)',
                            borderWidth: 1,
                            pointRadius: 8,
                            pointStyle: 'star'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Punto Óptimo') {
                                        return `Óptimo: (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)}) - Z = ${formatCurrency(valorOptimo)}`;
                                    }
                                    return `${context.dataset.label}: (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { min: 0, max: MAX_AXIS, title: { display: true, text: 'X (Técnicos de Hora Pico)', font: { size: 14, weight: 'bold' } } },
                        y: { min: 0, max: MAX_AXIS, title: { display: true, text: 'Y (Técnicos de Horario Regular)', font: { size: 14, weight: 'bold' } } }
                    }
                }
            });
        }

        // Event Listeners para los sliders
        document.getElementById('r1Slider').addEventListener('input', updateAnalysis);
        document.getElementById('r2Slider').addEventListener('input', updateAnalysis);

        // Carga inicial
        window.onload = updateAnalysis;
    </script>
</body>
</html>
